// nextflow.config
// first draft based on previous work from binf 528

// defining parameters
params {
    //indir = "./samples"
    outdir = "./results"
    publish_mode = 'copy'
    aws_region = 'us-east-2'  // default region, can be overridden by --aws_region
    
    reference_indexed_path = 's3://bp-wgs-covaris-input-data/reference/hg38_broad/Homo_sapiens_assembly38.{fasta,fasta.64.*}'
    reference_gatk_path = 's3://bp-wgs-covaris-input-data/reference/hg38_broad/Homo_sapiens_assembly38.{fasta,fasta.fai,dict}'
    
    // default known sites - all VCF files are in known_sites_hg38/
    // using both dbSNP (.vcf + .vcf.idx) and Mills indels (.vcf.gz + .vcf.gz.tbi) for better BQSR
    default_known_sites = 's3://bp-wgs-covaris-input-data/reference/known_sites_hg38/Homo_sapiens_assembly38.dbsnp138.vcf,s3://bp-wgs-covaris-input-data/reference/known_sites_hg38/Homo_sapiens_assembly38.dbsnp138.vcf.idx,s3://bp-wgs-covaris-input-data/reference/known_sites_hg38/Mills_and_1000G_gold_standard.indels.hg38.vcf.gz,s3://bp-wgs-covaris-input-data/reference/known_sites_hg38/Mills_and_1000G_gold_standard.indels.hg38.vcf.gz.tbi'
}


// all execution profiles for different deployments
profiles {
    
    // custom profile - requires all parameters to be specified explicitly
    custom {
        // no parameter defaults - user must provide all via command line
    }
    
    // process for aws; uses aws batch
    aws {
        // enable resume across different runs
        resume = true
        
        process {
            executor = 'awsbatch'
            queue = 'nextflow-compute-queue'
            
            // default process resources
            cpus = 2
            memory = '4.GB'
            time = '2.h'
            cache = 'deep'
            
            // specialized resource allocation
            withName: 'FASTQC' {
                cpus = 2
                memory = '4.GB'
                container = 'quay.io/biocontainers/fastqc:0.12.1--hdfd78af_0'
            }
            
            withName: 'FASTQC*' {
                container = 'quay.io/biocontainers/fastqc:0.12.1--hdfd78af_0'
            }
            
            withName: 'FASTP' {
                cpus = 4
                memory = '8.GB'
                container = 'quay.io/biocontainers/fastp:0.23.4--h5f740d0_0'
            }
            
            withName: 'MULTIQC' {
                cpus = 1
                memory = '2.GB'
                container = 'quay.io/biocontainers/multiqc:1.19--pyhdfd78af_0'
            }
            
            withName: 'BWA' {
                cpus = 8
                memory = '128.GB'
                time = '4.h'
                container = 'quay.io/biocontainers/mulled-v2-fe8faa35dbf6dc65a0f7f5d4ea12e31a79f73e40:66ed1b38d280722529bb8a0167b0cf02f8a0b488-0'
            }
            
            withName: 'SAMTOOLS_STATS' {
                cpus = 2
                memory = '16.GB'
                container = 'quay.io/biocontainers/samtools:1.17--h00cdaf9_0'
            }
            
            withName: 'SAMTOOLS_INDEX' {
                cpus = 1
                memory = '16.GB'
                time = '30.m'
                container = 'quay.io/biocontainers/samtools:1.17--h00cdaf9_0'
            }
            
            withName: 'QUALIMAP' {
                cpus = 4
                memory = '8.GB'
                time = '2.h'
                container = 'quay.io/biocontainers/qualimap:2.2.2d--1'
            }
            
            withName: 'PICARD_MARKDUPLICATES' {
                cpus = 4
                memory = '12.GB'
                time = '3.h'
                container = 'quay.io/biocontainers/picard:2.27.4--hdfd78af_0'
            }
            
            withName: 'PICARD_COLLECTINSERTSIZEMETRICS' {
                cpus = 2
                memory = '8.GB'
                time = '1.h'
                container = 'quay.io/biocontainers/picard:2.27.4--hdfd78af_0'
            }
            
            withName: 'MOSDEPTH' {
                cpus = 4
                memory = '8.GB'
                time = '3.h'
                container = 'quay.io/biocontainers/mosdepth:0.3.8--hd299d5a_0'
            }
            
            withName: 'GATK_BASERECALIBRATOR' {
                cpus = 4
                memory = '16.GB'
                time = '4.h'
                container = 'quay.io/biocontainers/gatk4:4.4.0.0--py36hdfd78af_0'
            }
            
            withName: 'GATK_APPLYBQSR' {
                cpus = 4
                memory = '16.GB'
                time = '4.h'
                container = 'quay.io/biocontainers/gatk4:4.4.0.0--py36hdfd78af_0'
            }
            
            withName: 'GATK_HAPLOTYPECALLER' {
                cpus = 8
                memory = '32.GB'
                time = '8.h'
                container = 'quay.io/biocontainers/gatk4:4.4.0.0--py36hdfd78af_0'
            }
            
            withName: 'GATK_COMBINEGVCFS' {
                cpus = 2
                memory = '8.GB'
                time = '2.h'
                container = 'quay.io/biocontainers/gatk4:4.4.0.0--py36hdfd78af_0'
            }
            
            withName: 'GATK_GENOTYPEGVCFS' {
                cpus = 4
                memory = '16.GB'
                time = '4.h'
                container = 'quay.io/biocontainers/gatk4:4.4.0.0--py36hdfd78af_0'
            }
            
            withName: 'GATK_VARIANTFILTRATION' {
                cpus = 2
                memory = '8.GB'
                time = '2.h'
                container = 'quay.io/biocontainers/gatk4:4.4.0.0--py36hdfd78af_0'
            }
            
            withName: 'BCFTOOLS_STATS' {
                cpus = 1
                memory = '4.GB'
                time = '1.h'
                container = 'quay.io/biocontainers/bcftools:1.17--haef29d1_0'
            }

            withName: 'MERGE_FASTQ' {
                cpus = 2
                memory = '8.GB'
                time = '2.h'
                container = 'quay.io/biocontainers/pigz:2.8'
            }
        }

        // AWS configuration with debugging and anonymous access for public buckets
        aws {
            region = params.aws_region ?: 'us-east-2'
            batch {
                maxParallelTransfers = 4
                maxTransferAttempts = 3
                debug = true
            }
            client {
                maxConnections = 20
                connectionTimeout = 300000
                uploadStorageClass = 'INTELLIGENT_TIERING'
                storageEncryption = 'AES256'
                debug = true
            }
        }
        
        // S3 work directory
        workDir = 's3://bp-wgs-covaris-nextflow-workdir/work'
        
        // store execution reports and timeline in S3 for persistence
        timeline {
            enabled = true
            file = 's3://bp-wgs-covaris-nextflow-workdir/reports/timeline.html'
        }
        report {
            enabled = true
            file = 's3://bp-wgs-covaris-nextflow-workdir/reports/report.html'
        }
        trace {
            enabled = true
            file = 's3://bp-wgs-covaris-nextflow-workdir/reports/trace.txt'
        }

        // enable fusion for S3 streaming
        fusion {
            enabled = true
        }
        wave {
            enabled = true
        }
    }
}

// pipeline metadata
manifest {
    name = 'wgs_covaris_ashg'
    description = 'NGS Quality Control & Analysis Pipeline'
    version = '1.0.0'
    nextflowVersion = '>=22.04.0'
}
